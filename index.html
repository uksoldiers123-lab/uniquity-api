
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Uniquity Solutions — Public Landing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #96A3B1;
      --text: #1f2937;
      --muted: #4b5563;
      --card: #ffffff;
      --primary: #e94b4b;
      --accent: #fbbf24;
      --shadow: 0 6px 20px rgba(0,0,0,.04);
      --radius: 12px;
      --nav-h: 56px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: var(--text); background: var(--bg); }
    nav { position: sticky; top:0; z-index:1000; background: linear-gradient(to bottom, rgba(150,163,177,0.95), rgba(150,163,177,0.6)); border-bottom:1px solid rgba(255,255,255,.3); height: var(--nav-h); }
    .nav-inner { display:flex; align-items:center; justify-content: space-between; padding: 12px 16px; max-width: 1100px; margin:0 auto; }
    .brand { display:flex; align-items:center; gap:10px; font-weight:700; color:#fff; }
    .brand-mark { width:28px; height:28px; border-radius:6px; background: linear-gradient(135deg, #fff, #ffd6a3); display:inline-block; }
    .container { width:100%; max-width:1100px; margin:0 auto; padding:0 16px; }

    .hero { padding:20px; border-radius:12px; background:#fff; border:1px solid #e5e7eb; box-shadow:var(--shadow); margin:20px 0; }
    .lead { color:#4b5563; font-size:16px; margin:0 0 8px; }

    .auth-wrap { display:flex; justify-content:center; padding: 8px; }
    .auth-card { width:100%; max-width: 520px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; box-shadow: var(--shadow); }

    .auth-tabs { display:flex; border-bottom:1px solid #eee; margin-bottom:8px; }
    .auth-tabs button { flex:1; padding:12px; border:0; background:#fff; font-weight:700; cursor: pointer; }
    .auth-form { display:flex; flex-direction:column; gap:10px; }
    input, button { font:inherit; }
    .input { padding:12px; border:1px solid #ddd; border-radius:8px; width:100%; }
    .btn { padding:12px 14px; border-radius:8px; border:0; font-weight:700; cursor:pointer; }
    .btn.primary { background: var(--primary); color:#fff; }
    .btn.secondary { background:#fff; color:var(--primary); border:1px solid var(--primary); }
    .status { min-height:18px; margin-top:6px; font-size:14px; }

    @media (min-width:700px) {
      .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    }
  </style>
</head>
<body>
  <nav class="nav" aria-label="Primary">
    <div class="nav-inner container">
      <div class="brand" aria-label="Brand">
        <span class="brand-mark" aria-hidden="true"></span>
        <span>Uniquity Solutions</span>
      </div>
    </div>
  </nav>

  <section class="container" id="home" aria-label="Public Landing">
    <div class="hero" aria-label="Intro">
      <h1 style="margin:0 0 8px; font-size: clamp(22px, 6vw, 40px); color:#1f2937;">Uniquity Solutions — Trusted Payments for 20+ Years</h1>
      <p class="lead" style="margin:0;">Sign up or sign in. Your session will be linked to a tenant and you’ll access a dashboard scoped to your tenant and role. Stripe onboarding can be toggled per tenant and enabled later.</p>
    </div>

    <div class="auth-wrap" aria-label="Signup and Login" style="margin-top:6px;">
      <!-- Distinct Sign Up Card -->
      <section aria-label="Signup" style="width:100%; max-width:520px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; box-shadow:var(--shadow);">
        <h2 style="font-size:14px; text-transform:uppercase; color:#64748b; margin:0 0 8px;">Create Account</h2>
        <form id="signup-form" class="auth-form" autocomplete="on" style="display:grid; grid-template-columns:1fr; gap:12px;">
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
            <input id="signupEmail" class="input" type="email" placeholder="Email" required />
            <input id="signupPassword" class="input" type="password" placeholder="Password" required />
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
            <input id="signupCompany" class="input" type="text" placeholder="Company name (tenant)" required />
            <input id="signupPhone" class="input" type="tel" placeholder="Phone (optional)" />
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
            <input id="signupDOB" class="input" type="date" placeholder="DOB" />
            <input id="signupAddress" class="input" type="text" placeholder="Address" />
          </div>
          <label style="display:flex; align-items:center; gap:8px;">
            <input id="enableStripeOnboard" type="checkbox" />
            Stripe onboarding (Express) after signup
          </label>
          <button id="btnSignup" type="button" class="btn primary" style="width:100%;">Create Account</button>
          <div id="signupStatus" class="status" aria-live="polite"></div>
        </form>
      </section>

      <!-- Distinct Login Card -->
      <section aria-label="Login" style="width:100%; max-width:520px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; box-shadow:var(--shadow);">
        <h2 style="font-size:14px; text-transform:uppercase; color:#64748b; margin:0 0 8px;">Login</h2>
        <form id="login-form" class="auth-form" autocomplete="on" style="display:grid; grid-template-columns:1fr; gap:12px;">
          <input id="loginEmail" class="input" type="email" placeholder="Email" required />
          <input id="loginPassword" class="input" type="password" placeholder="Password" required />
          <button id="btnLogin" type="button" class="btn primary" style="width:100%;">Login</button>
          <div id="loginStatus" class="status" aria-live="polite"></div>
        </form>
      </section>
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
  <script src="/env.js"></script>
  <script>
    const SUPABASE_URL = window.SUPABASE_URL;
    const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY;
    const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Helpers
    function setStatus(el, msg, isError = true) {
      if (!el) return;
      el.textContent = msg;
      el.style.color = isError ? '#e11' : '#1e40af';
    }

    // Signup flow
    async function signup(email, password, company, onboard) {
      // 1) Upsert/find tenant
      let tenant_id = null;
      const { data: existing } = await supabase.from("public.companies").select("id").eq("name", company).maybeSingle();
      if (existing?.id) {
        tenant_id = existing.id;
      } else {
        const slug = company.toLowerCase().trim().replace(/\s+/g, "-").replace(/[^a-z0-9\-]/g, "");
        const { data: newComp } = await supabase.from("public.companies").insert({ name: company, slug }).select("id").maybeSingle();
        tenant_id = newComp?.id || null;
      }

      // 2) Sign up user via Auth
      const { user, error } = await supabase.auth.signUp({ email, password });
      if (error) return { error: error.message };

      // 3) Map user to tenant
      await supabase.from("public.users").insert({ email, tenant_id, role: "tenant-user" }).maybeSingle();

      // 4) Get session token
      const session = await supabase.auth.getSession();
      const token = session?.data?.session?.access_token ?? null;
      return { user_id: user?.id ?? null, tenant_id, role: "tenant-user", token, onboarding_complete: !!onboard };
    }

    // Login flow
    async function login(email, password) {
      const { data: session, error } = await supabase.auth.signIn({ email, password });
      if (error) return { error: error.message };

      const { data: userRow } = await supabase.from("public.users").select("id as user_id, tenant_id, role").eq("email", email).maybeSingle();
      const user_id = userRow?.user_id ?? session?.user?.id ?? null;
      const tenant_id = userRow?.tenant_id ?? null;
      const role = userRow?.role ?? "tenant-user";

      const token = session?.access_token ?? null;
      return { token, user_id, tenant_id, role };
    }

    // Handlers
    document.getElementById("btnSignup").addEventListener("click", async () => {
      const email = document.getElementById("signupEmail").value;
      const password = document.getElementById("signupPassword").value;
      const company = document.getElementById("signupCompany").value;
      const phone = document.getElementById("signupPhone")?.value || "";
      const dob = document.getElementById("signupDOB")?.value || "";
      const address = document.getElementById("signupAddress")?.value || "";
      const onboard = document.getElementById("enableStripeOnboard").checked;

      if (!email || !password || !company) {
        setStatus(document.getElementById("signupStatus"), "Please fill Email, Password, and Company.", true);
        return;
      }
      try {
        const res = await signup(email, password, company, onboard);
        if (res?.error) {
          setStatus(document.getElementById("signupStatus"), res.error, true);
          return;
        }
        const loginRes = await login(email, password);
        if (loginRes?.token) {
          localStorage.setItem("token", loginRes.token);
          localStorage.setItem("user_id", loginRes.user_id);
          localStorage.setItem("tenant_id", loginRes.tenant_id);
          localStorage.setItem("role", loginRes.role);
          window.location.href = (loginRes.role === "admin" || loginRes.role === "owner" || loginRes.role === "treasury" || loginRes.role === "staff")
            ? "/admin-dashboard.html" : "/tenant-dashboard.html";
        } else {
          setStatus(document.getElementById("signupStatus"), loginRes?.error || "Signup completed. Please login.", true);
        }
      } catch (e) {
        console.error(e);
        setStatus(document.getElementById("signupStatus"), "Signup error", true);
      }
    });

    document.getElementById("btnLogin").addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      if (!email || !password) {
        setStatus(document.getElementById("loginStatus"), "Please enter email and password.", true);
        return;
      }
      try {
        const data = await login(email, password);
        if (data?.token) {
          localStorage.setItem("token", data.token);
          localStorage.setItem("user_id", data.user_id);
          localStorage.setItem("tenant_id", data.tenant_id);
          localStorage.setItem("role", data.role);
          window.location.href = (["admin","owner","treasury","staff"].includes(data.role))
            ? "/admin-dashboard.html" : "/tenant-dashboard.html";
        } else {
          setStatus(document.getElementById("loginStatus"), data?.error || "Login failed", true);
        }
      } catch (e) {
        console.error(e);
        setStatus(document.getElementById("loginStatus"), "Login error", true);
      }
    });
  </script>
</body>
</html>

