<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Uniquity Solutions â€” Public Landing</title>
  <style>
    body { font-family: -apple-system, "Segoe UI", Roboto, Arial, sans-serif; background:#f3f4f6; color:#1f2937; padding:12px; }
    .card { background:#fff; border-radius:12px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,.08); margin-bottom:12px; }
    input, button { width:100%; padding:12px; border-radius:8px; border:1px solid #ddd; font-size:16px; }
    .btn { background:#e11d48; color:#fff; border:0; font-weight:700; }
    #log { white-space:pre-wrap; font-family:monospace; font-size:12px; min-height:60px; border:1px dashed #e5e7eb; padding:8px; border-radius:8px; }
  </style>
  <style>
    /* Inline extra for responsiveness, if desired */
  </style>
</head>
<body>

  <div class="card" id="signupCard">
    <h3>Create Account</h3>
    <input id="signupEmail" placeholder="Email" type="email" />
    <input id="signupPassword" placeholder="Password" type="password" />
    <input id="signupTenant" placeholder="Tenant name" type="text" />
    <input id="signupPhone" placeholder="Phone (optional)" type="tel" />
    <input id="signupDOB" placeholder="DOB (YYYY-MM-DD)" type="text" />
    <input id="signupAddress" placeholder="Address" type="text" />
    <label><input id="enableStripeOnboard" type="checkbox" /> Stripe onboarding (Express) after signup</label>
    <button id="btnSignup" class="btn">Create Account</button>
    <div id="signupStatus" class="status" aria-live="polite"></div>
  </div>

  <div class="card" id="loginCard">
    <h3>Login</h3>
    <input id="loginEmail" placeholder="Email" type="email" />
    <input id="loginPassword" placeholder="Password" type="password" />
    <button id="btnLogin" class="btn" style="margin-top:8px;">Login</button>
    <div id="loginStatus" class="status" aria-live="polite"></div>
  </div>

  <div class="card" id="logCard" style="display:block;">
    <h3>Log</h3>
    <div id="log"></div>
  </div>

  <!-- Inline keys for testing (replace with secure loading in production) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
  <script>
    // Replace these with your real keys securely in production.
    // This is a test stub; do not leave real keys here in production or public repos.
    window.SUPABASE_URL = "https://ziltrcaehpshkwganlcy.supabase.co";
    window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJ6aWx0cmNhZWhwc2hqa3dHZ2FubGMiLCJyZWYiOiJ1c2VyIn0.signature_placeholder";

    const SUPABASE = Supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

    function log(m) {
      const el = document.getElementById('log');
      if (el) el.textContent += m + "\n";
      console.log(m);
    }

    function setStatus(el, msg, ok) {
      if (!el) return;
      el.textContent = msg;
      el.style.color = ok ? '#10b981' : '#e11d48';
    }

    // Signup flow
    document.getElementById("btnSignup").addEventListener("click", async () => {
      log("Signup button clicked");
      const email = document.getElementById("signupEmail").value;
      const password = document.getElementById("signupPassword").value;
      const tenant = document.getElementById("signupTenant").value;
      const phone = document.getElementById("signupPhone").value;
      const dob = document.getElementById("signupDOB").value;
      const address = document.getElementById("signupAddress").value;
      const onboard = document.getElementById("enableStripeOnboard").checked;

      try {
        // 1) Upsert tenant
        let tenant_id = null;
        const { data: t } = await SUPABASE.from('public.tenants').select('id').eq('name', tenant).maybeSingle();
        if (t?.id) {
          tenant_id = t.id;
        } else {
          const { data: nt } = await SUPABASE.from('public.tenants').insert({ name: tenant, express_connected: false }).select('id').maybeSingle();
          tenant_id = nt?.id;
        }
        log("Tenant_id: " + tenant_id);

        // 2) Sign up user
        const { user, error: signErr } = await SUPABASE.auth.signUp({ email, password });
        if (signErr) { setStatus(document.getElementById("signupStatus"), signErr.message, false); log("Signup error: " + signErr.message); return; }
        log("User created: " + user.id);

        // 3) Map tenant_users
        await SUPABASE.from('public.tenant_users').insert({ tenant_id, user_id: user.id, role: 'tenant-user', permissions: {} }).select('id').maybeSingle();
        log("Tenant-user mapping created");

        // 4) Optional: profile
        if (phone || dob || address) {
          await SUPABASE.from('public.user_profiles').insert({ user_id: user.id, phone, dob, address }).select('id').maybeSingle();
          log("Profile stored");
        }

        // 5) Sign in to get session
        const { data: session, error: loginErr } = await SUPABASE.auth.signIn({ email, password });
        if (loginErr) throw loginErr;
        log("Signed in; token present: " + (!!session?.access_token));

        // 6) Resolve IDs/role
        const { data: userRow } = await SUPABASE.from('public.users').select('id, tenant_id').eq('email', email).maybeSingle();
        const user_id = userRow?.id;
        const tenant_id = userRow?.tenant_id;

        const { data: tu } = await SUPABASE.from('public.tenant_users').select('role').eq('user_id', user_id).eq('tenant_id', tenant_id).maybeSingle();
        const role = tu?.role ?? 'tenant-user';
        log("Resolved role: " + role);

        // 7) Redirect (absolute)
        const redirectPath = (role === 'admin' || role === 'owner' || role === 'treasury' || role === 'staff')
          ? "https://dashboard.uniquitysolutions.com/public/admin/admin-dashboard.html"
          : "https://dashboard.uniquitysolutions.com/public/client-dashboard.html";
        log("Redirecting to: " + redirectPath);
        window.location.href = redirectPath;
      } catch (e) {
        log("Signup error: " + String(e));
        setStatus(document.getElementById("signupStatus"), String(e), false);
      }
    });

    // Minimal Login (optional, can be implemented similarly)
    document.getElementById("btnLogin").addEventListener("click", async () => {
      log("Login clicked");
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      try {
        const { data: session, error: loginErr } = await SUPABASE.auth.signIn({ email, password });
        if (loginErr) throw loginErr;

        // Resolve role
        const { data: userRow } = await SUPABASE.from('public.users').select('id, tenant_id').eq('email', email).maybeSingle();
        const user_id = userRow?.id;
        const tenant_id = userRow?.tenant_id;
        const { data: tu } = await SUPABASE.from('public.tenant_users').select('role').eq('user_id', user_id).eq('tenant_id', tenant_id).maybeSingle();
        const role = tu?.role ?? 'tenant-user';
        const redirectPath = (role === 'admin' || role === 'owner' || role === 'treasury' || role === 'staff')
          ? "https://dashboard.uniquitysolutions.com/public/admin/admin-dashboard.html"
          : "https://dashboard.uniquitysolutions.com/public/client-dashboard.html";
        log("Redirecting to: " + redirectPath);
        window.location.href = redirectPath;
      } catch (e) {
        log("Login error: " + String(e));
        document.getElementById("loginStatus").textContent = String(e);
      }
    });
  </script>
</body>
</html>
